<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>木製パズル The-T プロ</title>
    <style>
        :root {
            --wood-dark: #4e342e;
            --wood-mid: #8d6e63;
            --accent: #ff5722;
            --bg: #f5f5dc;
        }

        body {
            margin: 0;
            background: var(--bg);
            font-family: 'Hiragino Sans', sans-serif;
            overflow: hidden;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #header {
            width: 100%;
            background: var(--wood-dark);
            color: white;
            padding: 15px 0;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .instruction {
            font-size: 1rem;
            margin-bottom: 8px;
            color: #ffccbc;
            font-weight: bold;
        }

        .timer-box {
            font-size: 1.2rem;
            color: var(--accent);
            background: #000;
            padding: 2px 10px;
            border-radius: 4px;
        }

        .btn-group { margin-top: 10px; }
        .btn {
            padding: 6px 10px;
            margin: 0 2px;
            border: 1px solid #fff;
            border-radius: 4px;
            background: transparent;
            color: white;
            font-size: 0.75rem;
        }
        .btn.active { background: var(--accent); border-color: var(--accent); }

        #stage {
            position: relative;
            width: 100vw;
            height: calc(100vh - 150px);
        }

        #target-outline {
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px dashed rgba(0,0,0,0.1);
            pointer-events: none;
        }

        .piece {
            position: absolute;
            cursor: move;
            background: var(--wood-mid);
            background-image: 
                linear-gradient(90deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(0,0,0,0.1) 100%),
                repeating-linear-gradient(0deg, transparent, transparent 20px, rgba(0,0,0,0.05) 21px);
            box-shadow: 3px 3px 6px rgba(0,0,0,0.4);
            transform-origin: center center;
            z-index: 10;
        }

        /* ピース形状定義 */
        #p1 { width: 100px; height: 50px; clip-path: polygon(0% 0%, 100% 0%, 50% 100%, 0% 100%); }
        #p2 { width: 150px; height: 50px; clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 33% 100%); }
        #p3 { width: 100px; height: 100px; clip-path: polygon(0% 0%, 100% 0%, 100% 50%, 50% 50%, 0% 100%); }
        #p4 { width: 100px; height: 100px; clip-path: polygon(0% 0%, 50% 50%, 0% 100%); }

        .fixed { opacity: 0.8; box-shadow: none; pointer-events: none; }

        #overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            color: gold;
            text-align: center;
            flex-direction: column;
            justify-content: center;
        }
    </style>
</head>
<body>

<div id="header">
    <div class="instruction">全てのピースを使ってTの字を作ろう！</div>
    <div>TIME: <span id="timer" class="timer-box">--</span></div>
    <div class="btn-group">
        <button class="btn" id="btn-beginner" onclick="changeMode('beginner')">超初級</button>
        <button class="btn active" id="btn-easy" onclick="changeMode('easy')">初級</button>
        <button class="btn" id="btn-hard" onclick="changeMode('hard')">上級</button>
    </div>
</div>

<div id="stage">
    <div id="target-outline"></div>
    <div id="p1" class="piece" data-id="1"></div>
    <div id="p2" class="piece" data-id="2"></div>
    <div id="p3" class="piece" data-id="3"></div>
    <div id="p4" class="piece" data-id="4"></div>
</div>

<div id="overlay">
    <h2 id="msg-title"></h2>
    <p id="msg-body"></p>
    <button class="btn" style="background:var(--accent); font-size:1.2rem; padding:15px; margin-top:20px;" onclick="restart()">もう一度挑戦！</button>
</div>

<script>
    const state = { 1: {x:0,y:0,r:0}, 2: {x:0,y:0,r:0}, 3: {x:0,y:0,r:0}, 4: {x:0,y:0,r:0} };
    const solution = {
        1: { x: 50, y: 0, r: 0 },
        2: { x: 0, y: 50, r: 180 },
        3: { x: 0, y: 0, r: 0 },
        4: { x: 100, y: 50, r: 180 }
    };

    let timeLeft = 120;
    let timerId = null;
    let activeP = null;
    let mode = 'easy';
    let offset = { x: 0, y: 0 };

    function init() {
        document.querySelectorAll('.piece').forEach(p => {
            p.addEventListener('touchstart', e => startDrag(e), {passive:false});
            p.addEventListener('mousedown', startDrag);
            let lastTap = 0;
            p.addEventListener('touchend', e => {
                let now = Date.now();
                if(now - lastTap < 300) rotate(p);
                lastTap = now;
                stopDrag();
            });
            p.addEventListener('dblclick', () => rotate(p));
        });
        window.addEventListener('mousemove', doDrag);
        window.addEventListener('touchmove', doDrag, {passive:false});
        window.addEventListener('mouseup', stopDrag);
        
        restart();
    }

    function changeMode(m) {
        mode = m;
        ['beginner', 'easy', 'hard'].forEach(x => 
            document.getElementById('btn-'+x).classList.toggle('active', m === x));
        document.getElementById('target-outline').style.opacity = (m === 'hard') ? "0.05" : "0.1";
        restart();
    }

    function restart() {
        document.getElementById('overlay').style.display = 'none';
        const target = document.getElementById('target-outline').getBoundingClientRect();
        
        // 全ピースを画面下方に配置
        const startY = window.innerHeight - 200;
        const spacing = window.innerWidth / 4;

        Object.keys(state).forEach((id, i) => {
            const p = document.querySelector(`[data-id="${id}"]`);
            p.classList.remove('fixed');
            
            // 超初級：ピース3(最大のL字)を正解位置に固定
            if(mode === 'beginner' && id === "3") {
                state[id].x = target.left + solution[id].x;
                state[id].y = target.top + solution[id].y;
                state[id].r = solution[id].r;
                p.classList.add('fixed');
            } else {
                state[id].x = spacing * i + 10;
                state[id].y = startY + (Math.random() * 50);
                state[id].r = Math.floor(Math.random() * 4) * 90;
            }
            render(id);
        });

        timeLeft = (mode === 'hard') ? 45 : 120;
        startTimer();
    }

    function startTimer() {
        clearInterval(timerId);
        updateTimerDisplay();
        timerId = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            if(timeLeft <= 0) showEnd("TIME UP", "焦らず、もう一度木のぬくもりを感じましょう。");
        }, 1000);
    }

    function updateTimerDisplay() {
        document.getElementById('timer').innerText = timeLeft + "s";
    }

    function startDrag(e) {
        if(e.target.classList.contains('fixed')) return;
        activeP = e.target;
        const pos = e.touches ? e.touches[0] : e;
        const id = activeP.dataset.id;
        offset.x = pos.clientX - state[id].x;
        offset.y = pos.clientY - state[id].y;
        activeP.style.zIndex = 1000;
    }

    function doDrag(e) {
        if(!activeP) return;
        e.preventDefault();
        const pos = e.touches ? e.touches[0] : e;
        const id = activeP.dataset.id;
        state[id].x = pos.clientX - offset.x;
        state[id].y = pos.clientY - offset.y;
        render(id);
    }

    function stopDrag() {
        if(activeP) {
            activeP.style.zIndex = 10;
            checkWin();
        }
        activeP = null;
    }

    function rotate(p) {
        if(p.classList.contains('fixed')) return;
        const id = p.dataset.id;
        state[id].r = (state[id].r + 90) % 360;
        render(id);
        checkWin();
    }

    function render(id) {
        const p = document.querySelector(`[data-id="${id}"]`);
        p.style.transform = `translate(${state[id].x}px, ${state[id].y}px) rotate(${state[id].r}deg)`;
    }

    function checkWin() {
        const target = document.getElementById('target-outline').getBoundingClientRect();
        let correct = 0;
        Object.keys(solution).forEach(id => {
            const s = solution[id];
            const dx = (state[id].x - target.left) - s.x;
            const dy = (state[id].y - target.top) - s.y;
            if(Math.abs(dx) < 20 && Math.abs(dy) < 20 && (state[id].r % 360) === s.r) correct++;
        });
        if(correct === 4) {
            clearInterval(timerId);
            showEnd("天才！お見事です！", "木製パズルマスターの称号を授けます。");
        }
    }

    function showEnd(title, body) {
        document.getElementById('msg-title').innerText = title;
        document.getElementById('msg-body').innerText = body;
        document.getElementById('overlay').style.display = 'flex';
    }

    init();
</script>
</body>
</html>