<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>木製パズル The-T 完全版</title>
    <style>
        :root {
            --wood-dark: #4e342e;
            --wood-mid: #8d6e63;
            --accent: #ff5722;
            --bg: #f5f5dc;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg);
            font-family: 'Hiragino Sans', sans-serif;
            overflow: hidden; /* スクロール禁止 */
            touch-action: none;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ヘッダー：画面上部に固定 */
        #header {
            flex: 0 0 auto;
            background: var(--wood-dark);
            color: white;
            padding: 10px 0;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .instruction { font-size: 0.9rem; color: #ffccbc; font-weight: bold; margin-bottom: 5px; }
        .timer-box { font-size: 1.1rem; color: var(--accent); background: #000; padding: 2px 8px; border-radius: 4px; }
        .btn-group { margin-top: 8px; }
        .btn {
            padding: 5px 8px;
            margin: 0 2px;
            border: 1px solid #fff;
            border-radius: 4px;
            background: transparent;
            color: white;
            font-size: 0.7rem;
        }
        .btn.active { background: var(--accent); border-color: var(--accent); }

        /* メインステージ */
        #stage {
            flex: 1 1 auto;
            position: relative;
            width: 100%;
            overflow: hidden;
        }

        /* T字のガイド枠 */
        #target-outline {
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px dashed rgba(0,0,0,0.1);
            pointer-events: none;
        }

        /* ピース */
        .piece {
            position: absolute;
            cursor: move;
            background: var(--wood-mid);
            background-image: 
                linear-gradient(90deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(0,0,0,0.1) 100%),
                repeating-linear-gradient(0deg, transparent, transparent 15px, rgba(0,0,0,0.05) 16px);
            box-shadow: 2px 4px 6px rgba(0,0,0,0.3);
            transform-origin: center center;
            z-index: 10;
            /* スマホ向けに少し縮小 */
            scale: 0.85;
        }

        #p1 { width: 100px; height: 50px; clip-path: polygon(0% 0%, 100% 0%, 50% 100%, 0% 100%); }
        #p2 { width: 150px; height: 50px; clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 33% 100%); }
        #p3 { width: 100px; height: 100px; clip-path: polygon(0% 0%, 100% 0%, 100% 50%, 50% 50%, 0% 100%); }
        #p4 { width: 100px; height: 100px; clip-path: polygon(0% 0%, 50% 50%, 0% 100%); }

        .fixed { opacity: 0.7; box-shadow: none; pointer-events: none; filter: brightness(0.8); }

        /* クリア・タイムアップ画面 */
        #overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            color: gold;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>

<div id="header">
    <div class="instruction">全てのピースを使ってTの字を作ろう！</div>
    <div>TIME: <span id="timer" class="timer-box">--</span></div>
    <div class="btn-group">
        <button class="btn" id="btn-beginner" onclick="changeMode('beginner')">超初級</button>
        <button class="btn active" id="btn-easy" onclick="changeMode('easy')">初級</button>
        <button class="btn" id="btn-hard" onclick="changeMode('hard')">上級</button>
    </div>
</div>

<div id="stage">
    <div id="target-outline"></div>
    <div id="p1" class="piece" data-id="1"></div>
    <div id="p2" class="piece" data-id="2"></div>
    <div id="p3" class="piece" data-id="3"></div>
    <div id="p4" class="piece" data-id="4"></div>
</div>

<div id="overlay">
    <h2 id="msg-title" style="font-size: 2.5rem; margin: 0;"></h2>
    <p id="msg-body" style="font-size: 1.1rem; color: #fff;"></p>
    <button class="btn" style="background:var(--accent); font-size:1.2rem; padding:12px 30px; margin-top:20px;" onclick="restart()">もう一度遊ぶ</button>
</div>

<script>
    const state = { 1: {x:0,y:0,r:0}, 2: {x:0,y:0,r:0}, 3: {x:0,y:0,r:0}, 4: {x:0,y:0,r:0} };
    const solution = {
        1: { x: 50, y: 0, r: 0 },
        2: { x: 0, y: 50, r: 180 },
        3: { x: 0, y: 0, r: 0 },
        4: { x: 100, y: 50, r: 180 }
    };

    let timeLeft = 120;
    let timerId = null;
    let activeP = null;
    let mode = 'easy';
    let offset = { x: 0, y: 0 };

    function init() {
        document.querySelectorAll('.piece').forEach(p => {
            p.addEventListener('touchstart', startDrag, {passive:false});
            p.addEventListener('mousedown', startDrag);
            let lastTap = 0;
            p.addEventListener('touchend', e => {
                let now = Date.now();
                if(now - lastTap < 300) rotate(p);
                lastTap = now;
                stopDrag();
            });
            p.addEventListener('dblclick', () => rotate(p));
        });
        window.addEventListener('mousemove', doDrag);
        window.addEventListener('touchmove', doDrag, {passive:false});
        window.addEventListener('mouseup', stopDrag);
        
        window.addEventListener('resize', restart); // 画面回転時などに対応
        restart();
    }

    function changeMode(m) {
        mode = m;
        ['beginner', 'easy', 'hard'].forEach(x => 
            document.getElementById('btn-'+x).classList.toggle('active', m === x));
        document.getElementById('target-outline').style.opacity = (m === 'hard') ? "0.05" : "0.1";
        restart();
    }

    function restart() {
        document.getElementById('overlay').style.display = 'none';
        const stage = document.getElementById('stage').getBoundingClientRect();
        const target = document.getElementById('target-outline').getBoundingClientRect();
        
        // ピースを並べるための下部スペースの計算
        const footerY = stage.height - 120; // 画面下端から120px上に配置
        const spacing = stage.width / 4;

        Object.keys(state).forEach((id, i) => {
            const p = document.querySelector(`[data-id="${id}"]`);
            p.classList.remove('fixed');
            
            if(mode === 'beginner' && id === "3") {
                // 正解の位置にセット
                state[id].x = target.left + solution[id].x;
                state[id].y = target.top - stage.top + solution[id].y;
                state[id].r = solution[id].r;
                p.classList.add('fixed');
            } else {
                // 画面幅に等間隔で配置
                state[id].x = (spacing * i) + (spacing / 2) - 50; 
                state[id].y = footerY;
                state[id].r = Math.floor(Math.random() * 4) * 90;
            }
            render(id);
        });

        timeLeft = (mode === 'hard') ? 45 : 120;
        startTimer();
    }

    function startTimer() {
        clearInterval(timerId);
        updateTimerDisplay();
        timerId = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            if(timeLeft <= 0) showEnd("TIME UP", "焦らず、もう一度挑戦しましょう！");
        }, 1000);
    }

    function updateTimerDisplay() {
        document.getElementById('timer').innerText = timeLeft + "s";
    }

    function startDrag(e) {
        if(e.target.classList.contains('fixed')) return;
        activeP = e.target;
        const pos = e.touches ? e.touches[0] : e;
        const id = activeP.dataset.id;
        offset.x = pos.clientX - state[id].x;
        offset.y = pos.clientY - state[id].y;
        activeP.style.zIndex = 1000;
    }

    function doDrag(e) {
        if(!activeP) return;
        e.preventDefault();
        const pos = e.touches ? e.touches[0] : e;
        const id = activeP.dataset.id;
        state[id].x = pos.clientX - offset.x;
        state[id].y = pos.clientY - offset.y;
        render(id);
    }

    function stopDrag() {
        if(activeP) {
            activeP.style.zIndex = 10;
            checkWin();
        }
        activeP = null;
    }

    function rotate(p) {
        if(p.classList.contains('fixed')) return;
        const id = p.dataset.id;
        state[id].r = (state[id].r + 90) % 360;
        render(id);
        checkWin();
    }

    function render(id) {
        const p = document.querySelector(`[data-id="${id}"]`);
        p.style.left = "0px"; // 基準をリセット
        p.style.top = "0px";
        p.style.transform = `translate(${state[id].x}px, ${state[id].y}px) rotate(${state[id].r}deg)`;
    }

    function checkWin() {
        const stage = document.getElementById('stage').getBoundingClientRect();
        const target = document.getElementById('target-outline').getBoundingClientRect();
        let correct = 0;
        Object.keys(solution).forEach(id => {
            const s = solution[id];
            // ターゲット座標からの相対位置（Stage基準）
            const dx = (state[id].x - target.left) - s.x;
            const dy = (state[id].y - (target.top - stage.top)) - s.y;
            
            if(Math.abs(dx) < 20 && Math.abs(dy) < 20 && (state[id].r % 360) === s.r) {
                correct++;
            }
        });
        if(correct === 4) {
            clearInterval(timerId);
            showEnd("天才！CLEAR！！", "素晴らしい空間把握能力です！");
        }
    }

    function showEnd(title, body) {
        document.getElementById('msg-title').innerText = title;
        document.getElementById('msg-body').innerText = body;
        document.getElementById('overlay').style.display = 'flex';
    }

    init();
</script>
</body>
</html>